@{
    ViewData["Title"] = "Index";
    Layout = "~/Views/Shared/_LayoutSite.cshtml";

    var projectId = ViewBag.ProjectId as string ?? "";
    var projectName = ViewBag.ProjectName as string ?? "Queue Bank";
}

<div class="container-fluid">
    <div class="page-title">
        <div class="row">
            <div class="col-6">
                <h4>Queue Bank</h4>
            </div>
            <div class="col-6">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item">
                        <a href="@Url.Action("Index", "Home")">
                            <svg class="stroke-icon">
                                <use xlink:href="@Url.Content("~/assets/svg/icon-sprite.svg#stroke-home")"></use>
                            </svg>
                        </a>
                    </li>
                    <li class="breadcrumb-item">Queue</li>
                    <li class="breadcrumb-item">Queue Bank</li>
                    <li class="breadcrumb-item active">Customer View</li>
                </ol>
            </div>
        </div>
    </div>
</div>

<!-- ✅ เก็บ ProjectID ไว้ให้ JS ใช้ -->
<input type="hidden" id="hidProjectId" value="@projectId" />

<div class="container-fluid">
    <div class="row g-4 align-items-start">
        <!-- LEFT: Project Table -->
        <div class="col-lg-7">
            <div class="card project-card">
                <div class="card-header d-flex align-items-center justify-content-between">
                    <h5 class="mb-0 fw-bold" id="project_name">@projectName</h5>

                    <button id="btnRefreshCustomerView"
                            type="button"
                            class="btn btn-outline-primary btn-sm">
                        <i class="fa fa-refresh me-1"></i> Refresh
                    </button>
                </div>

                <div class="card-body p-3">
                    <div class="table-responsive">
                        <!-- ✅ Table ที่ DataTables ใช้ -->
                        <table id="customerQueueTable" class="table table-hover table-nowrap queue-table mb-0">
                            <thead>
                                <tr>
                                    <th style="width:60px;">No.</th>
                                    <th style="width:120px;">Unit Code</th>
                                    <th>Customer Name</th>
                                    <th style="width:140px;">Appointment</th>
                                    <th style="width:160px;">Status</th>
                                    <th style="width:100px;">Time</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- JS จะเติมเอง -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <!-- ไม่ใช้ footer mock ของ DataTables -->
            </div>
        </div>

        <!-- RIGHT: Summary + Bank -->
        <div class="col-lg-5">
            <!-- ✅ placeholder กัน layout ยุบตอน fixed -->
            <div id="qbStickyRightPh"></div>

            <div id="qbStickyRight" class="qb-sticky-right">
                <!-- Summary card -->
                <div class="card mb-4">
                    <div class="card-header d-flex align-items-center justify-content-between">
                        <h6 class="mb-0 fw-bold">Summary</h6>
                    </div>
                    <div class="card-body">
                        <div class="row g-3 summary-grid">
                            <!-- ✅ 4 กล่อง Summary ใช้เฉพาะ Unit -->
                            <div class="col-6 col-md-3 col-lg-3">
                                <div class="summary-card sc-green">
                                    <div class="sc-head">Register</div>
                                    <div class="sc-body">
                                        <div class="sc-stat" id="sum-register-unit">0</div>
                                        <div class="sc-meta">Unit</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-6 col-md-3 col-lg-3">
                                <div class="summary-card sc-blue">
                                    <div class="sc-head">Queue</div>
                                    <div class="sc-body">
                                        <div class="sc-stat" id="sum-queue-unit">0</div>
                                        <div class="sc-meta">Unit</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-6 col-md-3 col-lg-3">
                                <div class="summary-card sc-orange">
                                    <div class="sc-head">In Process</div>
                                    <div class="sc-body">
                                        <div class="sc-stat" id="sum-inprocess-unit">0</div>
                                        <div class="sc-meta">Unit</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-6 col-md-3 col-lg-3">
                                <div class="summary-card sc-green">
                                    <div class="sc-head">Done</div>
                                    <div class="sc-body">
                                        <div class="sc-stat" id="sum-done-unit">0</div>
                                        <div class="sc-meta">Unit</div>
                                    </div>
                                </div>
                            </div>

                            <!-- ✅ ตาราง Summary Bank -->
                            <div class="col-12">
                                <div class="table-responsive qb-bank-scroll">
                                    <table class="table table-bordered align-middle text-center mb-0">
                                        <thead class="table-light">
                                            <tr>
                                                <th class="text-start">ธนาคาร</th>
                                                <th style="width:120px;">จำนวน</th>
                                                <th style="width:80px;">%</th>
                                            </tr>
                                        </thead>
                                        <tbody id="summary-bank-body">
                                            <tr>
                                                <td colspan="3" class="text-center text-muted">
                                                    Loading...
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
            </div><!-- /qb-sticky-right -->
        </div>
    </div>

</div>

@section Scripts {
    <link rel="stylesheet" type="text/css" href="~/css/queuebankcustomerview.css?ver=@DateTime.Now.Ticks.ToString()">
    <script src="~/js/Pages/QueueBank/QueueBankCustomerView.js?v=@DateTime.Now.Ticks"></script>
    <script src="~/js/jquery.signalR-2.4.2.js"></script>
    <script src="~/js/app-signalr.js?ver=@DateTime.Now.Ticks.ToString()"></script>
    <script src="~/js/Pages/QueueBank/QueueBankCustomerView.SignalR.js?v=@DateTime.Now.Ticks"></script>

    <script>
        // ✅ เปิดเฉพาะหน้านี้
        document.body.classList.add("qb-cv-sticky");

        (function () {
            const header = document.querySelector(".page-header");
            const stickyEl = document.getElementById("qbStickyRight");
            const ph = document.getElementById("qbStickyRightPh");
            if (!stickyEl || !ph) return;

            const isLg = () => window.matchMedia("(min-width: 992px)").matches;

            const setTopVar = () => {
                const h = header ? Math.ceil(header.getBoundingClientRect().height || 0) : 0;
                document.documentElement.style.setProperty("--qb-topbar-h", (h + 73) + "px");
            };

            const applyFixed = () => {
                if (!isLg()) {
                    stickyEl.classList.remove("qb-fixed");
                    stickyEl.style.removeProperty("left");
                    stickyEl.style.removeProperty("width");
                    ph.style.height = "0px";
                    return;
                }

                // วัดตำแหน่ง/ขนาด "คอลัมน์ขวา" ให้ชัวร์ (กันกรณี stickyEl เคยโดน fixed แล้ว)
                const col = stickyEl.closest(".col-lg-5");
                const rect = (col || stickyEl).getBoundingClientRect();

                // ทำ placeholder ให้สูงเท่ากล่องจริง (ก่อน fixed)
                // (ถ้า stickyEl ถูก fixed อยู่แล้ว ให้ใช้ scrollHeight)
                const h = stickyEl.classList.contains("qb-fixed")
                    ? stickyEl.scrollHeight
                    : stickyEl.getBoundingClientRect().height;

                ph.style.height = h + "px";

                // เปิดโหมด fixed
                stickyEl.classList.add("qb-fixed");
                stickyEl.style.left = rect.left + "px";
                stickyEl.style.width = rect.width + "px";
            };

            const init = () => {
                setTopVar();
                applyFixed();
            };

            // init หลัง layout render
            setTimeout(init, 0);

            window.addEventListener("resize", () => {
                setTopVar();
                applyFixed();
            });

            // บังคับ recalibrate ตอนโหลดเสร็จ (DataTables/รูป/ฟอนต์)
            window.addEventListener("load", () => {
                setTopVar();
                applyFixed();
            });
        })();
    </script>
}
