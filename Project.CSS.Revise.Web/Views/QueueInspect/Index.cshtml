@{
    ViewData["Title"] = "Index";
    Layout = "~/Views/Shared/_LayoutSite.cshtml";

    var buList = ViewBag.listBu as IEnumerable<dynamic> ?? Enumerable.Empty<dynamic>();
    var projectList = ViewBag.listProject as IEnumerable<dynamic> ?? Enumerable.Empty<dynamic>();
    var ExpecttransferList = ViewBag.listExpecttransfer as IEnumerable<dynamic> ?? Enumerable.Empty<dynamic>();
    var UnitstatuscsList = ViewBag.listUnitstatuscs as IEnumerable<dynamic> ?? Enumerable.Empty<dynamic>();
    var CSResponsList = ViewBag.listgCSRespons as IEnumerable<dynamic> ?? Enumerable.Empty<dynamic>();
}

<div class="container-fluid">
    <div class="page-title">
        <div class="row">
            <div class="col-6">
                <h4>Queue Inspect</h4>
            </div>
            <div class="col-6">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item">
                        <a href="index.html">
                            <svg class="stroke-icon">
                                <use xlink:href="@Url.Content("~/assets/svg/icon-sprite.svg#stroke-home")"></use>
                            </svg>
                        </a>
                    </li>
                    <li class="breadcrumb-item">Queue</li>
                    <li class="breadcrumb-item active">Queue Inspect</li>
                </ol>
            </div>
        </div>
    </div>
</div>

<div class="container-fluid">

    <!-- Filters card -->
    <div class="card filter-card">
        <div class="card-header d-flex align-items-center justify-content-between">
            <h5 class="mb-0">Filters</h5>
            <button class="btn btn-sm btn-outline-secondary d-flex align-items-center gap-1"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#fltCollapse"
                    aria-expanded="true"
                    aria-controls="fltCollapse">
                <i class="fa fa-chevron-up"></i>
            </button>
        </div>

        <div id="fltCollapse" class="collapse show">
            <div class="card-body">
                <div class="row g-3 filter-grid">

                    <div class="col-12 col-md-4">
                        <label for="ddl_BUG" class="form-label fw-bold">BUG</label>
                        <select id="ddl_BUG" class="form-control multi-select" multiple>
                            @foreach (var bu in buList)
                            {
                                <option value="@bu.ID">@bu.Name</option>
                            }
                        </select>
                    </div>

                    <div class="col-12 col-md-4">
                        <label for="ddl_Project" class="form-label fw-bold">Project</label>
                        <select id="ddl_Project" class="form-control">
                            @foreach (var p in projectList)
                            {
                                <option value="@p.ValueString">@p.Text</option>
                            }
                        </select>
                    </div>

                    <div class="col-12 col-md-4">
                        <label for="ddl_UnitCode" class="form-label fw-bold">Unit Code</label>
                        <select id="ddl_UnitCode" class="form-control multi-select" multiple></select>
                    </div>

                    <div class="col-12 col-md-4">
                        <label for="ddl_CS_Response" class="form-label fw-bold">CS Response</label>
                        <select id="ddl_CS_Response" class="form-control multi-select" multiple>
                            @foreach (var cs in CSResponsList)
                            {
                                var val = (cs.ValueInt ?? "").ToString();
                                var text = (cs.Text ?? "").ToString();
                                <option value="@val">@text</option>
                            }
                        </select>
                    </div>

                    <div class="col-12 col-md-4">
                        <label for="ddl_Unit_Status_CS" class="form-label fw-bold">Unit Status CS</label>
                        <select id="ddl_Unit_Status_CS" class="form-control multi-select" multiple>
                            @foreach (var et in UnitstatuscsList)
                            {
                                var val = (et.ValueInt ?? "").ToString();
                                var text = (et.Text ?? "").ToString();
                                <option value="@val">@text</option>
                            }
                        </select>
                    </div>

                    <div class="col-12 col-md-4">
                        <label for="ddl_Expect_Transfer_By" class="form-label fw-bold">Expect Transfer By</label>
                        <select id="ddl_Expect_Transfer_By" class="form-control multi-select" multiple>
                            @foreach (var et in ExpecttransferList)
                            {
                                var val = (et.ValueInt ?? "").ToString();
                                var text = (et.Text ?? "").ToString();
                                <option value="@val">@text</option>
                            }
                        </select>
                    </div>

                    <div class="col-12 col-md-4">
                        <label for="ddl_Inspect_Round" class="form-label fw-bold">Inspection Round</label>
                        <select id="ddl_Inspect_Round" class="form-control multi-select" multiple>
                            <option value="1">ครั้งที่ 1</option>
                            <option value="2">ครั้งที่ 2</option>
                            <option value="3">ครั้งที่ 3</option>
                            <option value="N">ครั้งที่ N</option>
                        </select>
                    </div>

                    <div class="col-12 col-md-6" id="filter-register-date">
                        <label class="form-label fw-bold">Register Date</label>
                        <div class="input-group">
                            <input type="text"
                                   id="txt_RegisterDateStart"
                                   class="form-control qi-date-input"
                                   placeholder="dd/mm/yyyy">
                            <span class="input-group-text qi-date-sep">-</span>
                            <input type="text"
                                   id="txt_RegisterDateEnd"
                                   class="form-control qi-date-input"
                                   placeholder="dd/mm/yyyy">
                        </div>
                    </div>

                </div>
            </div>

            <div class="card-footer d-flex justify-content-end align-items-center gap-2 flex-nowrap footer-actions p-2">
                <button id="btnFilterCancel" type="button" class="btn btn-outline-secondary btn-sm" onclick="ClearFilter()">
                    <i class="fa fa-undo me-1"></i> Cancel
                </button>
                <button id="btnSearch" class="btn btn-primary btn-sm" type="button">
                    <i class="fa fa-search me-1"></i> Search
                </button>
            </div>
        </div>
    </div>

    <!-- Project Table card -->
    <div class="card filter-card" id="cardProjectTable">
        <div class="card-header d-flex align-items-center justify-content-between">
            <div>
                <h5 class="mb-0" id="project-name-selected">Project Table</h5>
            </div>
            <div class="d-flex align-items-center gap-2">
                <button class="btn btn-sm btn-outline-success gap-1" onclick="openCreateRegister()">
                    <i class="fa fa-plus me-1"></i> Register
                </button>

                <button class="btn btn-sm btn-outline-secondary d-flex align-items-center gap-1"
                        type="button"
                        data-bs-toggle="collapse"
                        data-bs-target="#fltCollapseTable"
                        aria-expanded="true"
                        aria-controls="fltCollapseTable">
                    <i class="fa fa-chevron-up"></i>
                </button>
            </div>
        </div>

        <div id="fltCollapseTable" class="collapse show">
            <div class="card-body">
                <div class="project-table-card">
                    <div class="card-body p-3">
                        <div class="qb-table-wrap">

                            <table id="QueueBankRegisterTable" class="table table-bordered table-hover mb-0 qb-table">
                                <thead>
                                    <tr>
                                        <th class="col-no">#</th>
                                        <th class="col-unit">Unit Code</th>
                                        <th class="col-customer">Customer Name</th>
                                        <th class="col-appoint">Appointment</th>
                                        <th class="col-status">Status</th>
                                        <th class="col-time">Time</th>
                                        <th class="col-counter">Counter</th>
                                        <th class="col-unitstatus">Unit Status CS</th>
                                        <th class="col-resp">Responsible</th>
                                        <th class="col-csresp">CS Response</th>
                                        <th class="col-action"></th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>

                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Summary Register card -->
    <div class="card filter-card" id="cardSummaryRegister">
        <div class="card-header d-flex align-items-center justify-content-between">

            <!-- Left side -->
            <div>
                <h5 class="mb-0" id="Show_Name_selected">Summary Register Inspect :</h5>
                <small id="sum-register-date" class="text-muted"></small>
            </div>

            <!-- Right side buttons -->
            <div class="d-flex align-items-center gap-2">
                <!-- ✅ Summary toggle -->
                <button id="btnSummaryToggle"
                        type="button"
                        class="btn btn-sm btn-outline-secondary"
                        title="Change Summary view"
                        aria-label="Change Summary view">
                    <i class="fa fa-table" aria-hidden="true"></i>
                </button>

                <!-- ✅ Checking toggle -->
                <button id="btnCheckingToggle"
                        type="button"
                        class="btn btn-sm btn-outline-secondary"
                        title="Change Checking view"
                        aria-label="Change Checking view">
                    <i class="fa fa-table" aria-hidden="true"></i>
                </button>

                <!-- collapse arrow -->
                <button class="btn btn-sm btn-outline-secondary d-flex align-items-center gap-1"
                        type="button"
                        data-bs-toggle="collapse"
                        data-bs-target="#fltCollapseSummaryRegister"
                        aria-expanded="true"
                        aria-controls="fltCollapseSummaryRegister">
                    <i class="fa fa-chevron-up"></i>
                </button>
            </div>
        </div>

        <div id="fltCollapseSummaryRegister" class="collapse show">
            <div class="card-body">

                <!-- =========================
                     SUMMARY (toggle ได้)
                ========================== -->
                <div class="summary-register mt-3">

                    <!-- ✅ SUMMARY: CARD VIEW (default) -->
                    <div id="qi-summary-card-view">
                        <div id="qi-summary-5box" class="qi-summary-5box"></div>
                    </div>

                    <!-- ✅ SUMMARY: TABLE VIEW (hidden default) -->
                    <div id="qi-summary-table-view" class="d-none">
                        <div class="table-responsive">
                            <table class="table table-sm table-bordered mb-0 qi-table-4border">
                                <thead>
                                    <tr>
                                        <th style="width: 160px;">Topic</th>
                                        <th class="text-center" style="width: 120px;">Unit</th>
                                        <th class="text-center" style="width: 160px;">Value</th>
                                        <th class="text-center" style="width: 90px;">%</th>
                                    </tr>
                                </thead>
                                <tbody id="qi-summary-tbody"></tbody>
                            </table>
                        </div>
                    </div>

                </div>

                <hr class="my-3" />

                <!-- =========================
                     CHECKING (toggle ได้ แยกจาก summary)
                ========================== -->
                <div class="summary-register">

                    <!-- ✅ CHECKING: CARD VIEW (default) -->
                    <div id="qi-checking-card-view">
                        <div id="qi-checking-5box" class="qi-summary-5box"></div>
                    </div>

                    <!-- ✅ CHECKING: TABLE VIEW (hidden default) -->
                    <div id="qi-checking-table-view" class="d-none">
                        <div class="table-responsive">
                            <table class="table table-sm table-bordered mb-0 qi-table-4border" id="qi-checking-table">
                                <thead>
                                    <tr>
                                        <th style="width: 260px;">Topic</th>
                                        <th class="text-center" style="width: 120px;">Unit</th>
                                        <th class="text-center" style="width: 140px;">Value</th>
                                        <th class="text-center" style="width: 90px;">%</th>
                                    </tr>
                                </thead>
                                <tbody id="qi-checking-tbody"></tbody>
                            </table>
                        </div>
                    </div>

                </div>


                <hr class="my-3" />

                <!-- =========================
                     TRANSFER TYPE (toggle ได้)
                ========================== -->
                <div class="summary-register" id="qi-transfer-section">

                    <div class="d-flex align-items-center justify-content-between mb-2">
                        <h6 class="mb-0">Transfer Type</h6>

                        <!-- ✅ Transfer toggle -->
                        <button id="btnTransferToggle"
                                type="button"
                                class="btn btn-sm btn-outline-secondary"
                                title="Change Transfer view"
                                aria-label="Change Transfer view">
                            <i class="fa fa-table" aria-hidden="true"></i>
                        </button>
                    </div>

                    <!-- ✅ TRANSFER: CARD VIEW (default) -->
                    <div id="qi-transfer-card-view">
                        <div id="qi-transfer-5box" class="qi-summary-5box"></div>
                    </div>

                    <!-- ✅ TRANSFER: TABLE VIEW (hidden default) -->
                    <div id="qi-transfer-table-view" class="d-none">
                        <div class="table-responsive">
                            <table class="table table-sm table-bordered mb-0 qi-table-4border" id="qi-transfer-table">
                                <thead>
                                    <tr>
                                        <th style="width:260px;">TransferType</th>
                                        <th class="text-center" style="width:120px;">Cnt_unit</th>
                                        <th class="text-center" style="width:140px;">Sum_unit</th>
                                        <th class="text-center" style="width:90px;">Percent_Unit</th>
                                    </tr>
                                </thead>
                                <tbody id="qi-transfer-tbody"></tbody>
                            </table>
                        </div>
                    </div>

                </div>


            </div>
        </div>
    </div>


    <!-- =========================
         MODAL: Register New Unit (Fullscreen)
    ========================= -->
    <div class="modal fade" id="modalCreateRegister" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-fullscreen">
            <div class="modal-content qi-reg-modal">

                <!-- Header -->
                <div class="modal-header qi-reg-header">

                    <div class="qi-reg-header-left">

                        <div class="qi-reg-header-icon">
                            <i data-feather="clipboard"></i>
                        </div>

                        <div class="qi-reg-header-text">
                            <div class="qi-reg-title">Register Unit</div>
                            <div class="qi-reg-subtitle">Project name</div>
                        </div>

                    </div>

                    <button type="button"
                            class="qi-reg-close"
                            data-bs-dismiss="modal"
                            aria-label="Close">
                        <i data-feather="x"></i>
                    </button>

                </div>

                <!-- Body -->
                <div class="modal-body qi-reg-body">

                    <!-- Top center form row (Modern) -->
                    <div class="qi-reg-topbar">

                        <div class="qi-reg-topbar-inner">

                            <!-- label + icon -->
                            <div class="qi-reg-field-label">
                                <span class="qi-reg-field-ico"><i data-feather="home"></i></span>
                                <span class="qi-reg-field-text">
                                    Unit Code <span class="text-danger">*</span>
                                </span>
                            </div>

                            <!-- select with icon -->
                            <div class="qi-reg-select-wrap qi-reg-select-modern">
                                

                                <select id="ddl_RegisterUnit" class="form-control qi-reg-select">
                                    <option value="">-- Select Unit --</option>
                                    <option value="26/5">26/5</option>
                                    <option value="26/4">26/4</option>
                                    <option value="26/3">26/3</option>
                                    <option value="26/2">26/2</option>
                                    <option value="26/1">26/1</option>
                                </select>
                            </div>

                            <!-- save button (modern) -->
                            <button id="btnRegisterSave"
                                    type="button"
                                    class="qi-btn-primary">
                                <i data-feather="save"></i>
                                <span>Save</span>
                            </button>

                        </div>

                    </div>


                    <!-- Table area -->
                    <div class="qi-reg-table-area">
                        <div class="qi-reg-table-card">
                            <div class="qi-reg-table-wrap">
                                <table id="tblRegisterList" class="table table-bordered table-hover mb-0 qi-reg-table">
                                    <thead>
                                        <tr>
                                            <th style="width:70px;">No.</th>
                                            <th style="width:140px;">Unit Code</th>
                                            <th>Customer Name</th>
                                            <th style="width:220px;">Responsible Name</th>
                                            <th style="width:170px;">Register</th>
                                            <th style="width:120px;">Wait</th>
                                            <th style="width:150px;">In Process</th>
                                            <th style="width:120px;">FastFix</th>
                                            <th style="width:150px;">FixedDuration</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- mock rows -->
                                        <tr>
                                            <td class="text-center">1</td>
                                            <td class="text-center"><a href="#" class="qi-reg-link">26/5</a></td>
                                            <td>นางกาญ อัคราพงศา, นางสาวอลิสา อัคราพงศา</td>
                                            <td class="text-center">-</td>
                                            <td class="text-center">2025-09-15 14:22</td>
                                            <td class="text-center"></td>
                                            <td class="text-center"></td>
                                            <td class="text-center"></td>
                                            <td class="text-center"></td>
                                        </tr>
                                        <tr>
                                            <td class="text-center">2</td>
                                            <td class="text-center"><a href="#" class="qi-reg-link">26/4</a></td>
                                            <td>นายกฤษณ์ ศุภสินธรักษ์</td>
                                            <td class="text-center">พรพิมล</td>
                                            <td class="text-center">2025-09-15 13:18</td>
                                            <td class="text-center"></td>
                                            <td class="text-center">2025-09-15 13:45</td>
                                            <td class="text-center"></td>
                                            <td class="text-center"></td>
                                        </tr>
                                        <tr>
                                            <td class="text-center">3</td>
                                            <td class="text-center"><a href="#" class="qi-reg-link">26/3</a></td>
                                            <td>นายอนุพน กมล</td>
                                            <td class="text-center">พรพิมล</td>
                                            <td class="text-center">2025-09-15 13:18</td>
                                            <td class="text-center"></td>
                                            <td class="text-center">2025-09-15 13:44</td>
                                            <td class="text-center"></td>
                                            <td class="text-center"></td>
                                        </tr>
                                        <tr>
                                            <td class="text-center">4</td>
                                            <td class="text-center"><a href="#" class="qi-reg-link">26/2</a></td>
                                            <td>นายสิทธิรณัฐ รัตนิแมนพฤกษ์</td>
                                            <td class="text-center">พรพิมล</td>
                                            <td class="text-center">2025-09-15 13:17</td>
                                            <td class="text-center"></td>
                                            <td class="text-center">2025-09-15 13:17</td>
                                            <td class="text-center"></td>
                                            <td class="text-center"></td>
                                        </tr>
                                        <tr>
                                            <td class="text-center">5</td>
                                            <td class="text-center"><a href="#" class="qi-reg-link">26/1</a></td>
                                            <td>นายชยุต ดิษยวณิช</td>
                                            <td class="text-center">Pimmada</td>
                                            <td class="text-center">2025-09-15 13:12</td>
                                            <td class="text-center"></td>
                                            <td class="text-center">2025-09-15 13:16</td>
                                            <td class="text-center"></td>
                                            <td class="text-center"></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>

                            <!-- footer inside card (optional) -->
                            <div class="qi-reg-table-foot text-muted small">
                                Showing 1 to 5 of 5 entries
                            </div>
                        </div>
                    </div>

                </div>

                <!-- Footer -->
                <div class="modal-footer qi-reg-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                        Close
                    </button>
                </div>

            </div>
        </div>
    </div>

</div>

@section Scripts {

    <!-- Flatpickr -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

    <!-- DataTables -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/datatables.net-dt/css/jquery.dataTables.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/datatables.net/js/jquery.dataTables.min.js"></script>

    <!-- Your JS -->
    <script src="~/js/Pages/QueueInspect/Page_Load.js?ver=@DateTime.Now.Ticks.ToString()"></script>
    <script src="~/js/Pages/QueueInspect/LoadingDDLProjectANDUnit.js?ver=@DateTime.Now.Ticks.ToString()"></script>
    <script src="~/js/Pages/QueueInspect/SearchListQueueInspect.js?ver=@DateTime.Now.Ticks.ToString()"></script>

    <!-- Your CSS -->
    <link rel="stylesheet" type="text/css" href="~/css/queueinspect.css?ver=@DateTime.Now.Ticks.ToString()">

    <script>
        $(document).ready(function () {
            window.QI_ORG_PROJECT_HTML = $("#ddl_Project").html();

            QI_InitBUG(function () {
                QI_InitProject(function () {
                    QI_ResetUnit(function () {
                        QI_InitInspectRound(function () {
                            QI_InitCSResponse(function () {
                                QI_InitUnitStatusCS(function () {
                                    QI_InitExpectTransferBy(function () {

                                        QI_BindDropdownEvents();

                                        // ✅ NEW: apply cookie default project + load unit (with callback)
                                        QI_ApplyDefaultProjectFromCookie(function () {

                                            initQueueInspectRegisterTable(function (dt) {
                                                QI_InitSummaryToggle(function (ok) {
                                                    console.log("Summary toggle ready:", ok);
                                                });
                                            });

                                        });

                                    });
                                });
                            });
                        });
                    });
                });
            });
        });

    </script>
}
