@{
    Layout = "~/Views/Shared/_LayoutSite.cshtml";
}

<div class="container-fluid">
    <div class="page-title">
        <div class="row">
            <div class="col-6">
                <h4>Other Settings</h4>
            </div>
            <div class="col-6">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item">

                    </li>
                    <li class="breadcrumb-item">Pages</li>
                    <li class="breadcrumb-item active">Other Settings</li>
                </ol>
            </div>
        </div>
    </div>
</div>
<!-- Container-fluid starts-->
<div class="container-fluid">
    <div class="row size-column">
        <div class="box-col-12">
            <div class="row">
                <div class="col-12">
                    <!-- Search Bar -->
                    <div class="card p-3">
                        <div class="card-body">
                            <ul class="nav nav-pills nav-primary" id="pills-tab" role="tablist">
                                <li class="nav-item">
                                    <a class="nav-link" id="pills-counter-tab" data-bs-toggle="pill" href="#pills-counter" role="tab" aria-controls="pills-counter" aria-selected="false">Counter</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link active" id="pills-shop-event-tab" data-bs-toggle="pill" href="#pills-shop-event" role="tab" aria-controls="pills-shop-event" aria-selected="true">Shop & Event</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" id="pills-project-zone-tab" data-bs-toggle="pill" href="#pills-project-zone" role="tab" aria-controls="pills-project-zone" aria-selected="false">Project Zone</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" id="pills-land-office-tab" data-bs-toggle="pill" href="#pills-land-office" role="tab" aria-controls="pills-land-office" aria-selected="false">Land Office</a>
                                </li>
                            </ul>
                            <div class="tab-content" id="pills-tabContent">
                                <div class="tab-pane fade" id="pills-counter" role="tabpanel" aria-labelledby="pills-counter-tab">
                
                                </div>
                                <div class="tab-pane fade show active" id="pills-shop-event" role="tabpanel" aria-labelledby="pills-shop-event-tab">
                                    <div class="row g-2 align-items-end pt-3">

                                        <!-- BU Multi-select -->
                                        <div class="col-md-3">
                                            <label class="form-label fw-bold">BU</label>
                                            <form>
                                                <input id="ddl-bu-shop-event"
                                                       class="form-control"
                                                       name="tags"
                                                       placeholder="Type to search..."
                                                       />
                                            </form>
                                        </div>

                                        <!-- Project Single-select -->
                                        <div class="col-md-3" id="project-dropdown-container">
                                            <label class="form-label fw-bold">โครงการ</label>
                                            <form>
                                                <div id="project-loading" style="display: none;">
                                                    <div class="spinner-border text-primary spinner-border-sm" role="status">
                                                        <span class="visually-hidden">Loading...</span>
                                                    </div> กำลังโหลด...
                                                </div>

                                                <input id="ddl-project-shop-event"
                                                       class="form-control"
                                                       name="tags"
                                                       placeholder="Type to search..." />
                                            </form>
                                        </div>


                                        <!-- Date Range -->
                                        <div class="col-md-3">
                                            <label class="form-label fw-bold">วันที่</label>
                                            <input type="text" class="form-control" id="dateRange" placeholder="dd/mm/yyyy - dd/mm/yyyy" />
                                        </div>

                                        <!-- New Event Button -->
                                        <div class="col-md-3 text-end">
                                            <button type="button" class="btn btn-success w-100">
                                                <i class="fa fa-plus me-1"></i> New Event
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div class="tab-pane fade" id="pills-project-zone" role="tabpanel" aria-labelledby="pills-project-zone-tab">

                                </div>
                                <div class="tab-pane fade" id="pills-land-office" role="tabpanel" aria-labelledby="pills-land-office-tab">

                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- หลังจาก jQuery -->

@* @section Scripts {
    <script>
        function loadBUOptions(callback) {
            $('.loader-wrapper').show();
            $.ajax({
                url: baseUrl + 'OtherSettings/Page_Load',
                type: 'POST',
                dataType: 'json',
                success: function (res) {
                    if (res.success && res.buList?.length) {
                        const buInput = document.querySelector('#ddl-bu-shop-event');

                        if (buInput._tagify) {
                            buInput._tagify.destroy();
                        }

                        const buTagify = new Tagify(buInput, {
                            whitelist: res.buList.map(x => ({
                                value: x.ID.toString(),
                                label: x.Name
                            })),
                            dropdown: {
                                enabled: 0,
                                maxItems: 20,
                                closeOnSelect: false,
                                classname: "tagify-dropdown"
                            }
                        });

                        buInput.addEventListener('focus', () => buTagify.dropdown.show.call(buTagify));

                        // ✅ เมื่อ BU เปลี่ยน -> โหลด Project
                        buTagify.on('change', function (e) {
                            const selectedBU = buTagify.value.map(x => x.value).join(',');
                            loadProjectOptions(selectedBU);
                        });

                        if (typeof callback === 'function') callback();
                    }
                },
                error: function () {
                    console.error("โหลด BU ไม่สำเร็จ");
                },
                complete: function () {
                    $('.loader-wrapper').fadeOut();
                }
            });
        }


        function loadProjectOptions(buIds) {
            console.log("🔍 BU ที่เลือก:", buIds);

            $.ajax({
                url: baseUrl + 'OtherSettings/GetProjectListByBU',
                type: 'POST',
                dataType: 'json',
                data: { L_BUID: buIds },
                success: function (res) {
                    console.log("✅ Project Response:", res);

                    if (res.success && res.data?.length) {
                        const projectInput = document.querySelector('#ddl-project-shop-event');

                        if (!projectInput) {
                            console.warn("⚠️ ไม่พบ input id='ddl-project-shop-event'");
                            return;
                        }

                        // 🔄 ถ้ามี tagify เก่าอยู่ให้ลบทิ้งก่อน
                        if (projectInput._tagify) {
                            projectInput._tagify.destroy();
                        }

                        const tagify = new Tagify(projectInput, {
                            enforceWhitelist: true,
                            maxTags: 1, // ⛔ ใช้ได้แค่ 1 ตัว (single select)
                            whitelist: res.data.map(x => ({
                                value: x.ProjectID,
                                label: x.ProjectNameTH
                            })),
                            dropdown: {
                                enabled: 0,
                                maxItems: 20,
                                closeOnSelect: true,
                                classname: "tagify-dropdown"
                            }
                        });

                        // 💬 Show dropdown on focus
                        projectInput.addEventListener('focus', () => tagify.dropdown.show.call(tagify));
                    } else {
                        console.warn("⚠️ ไม่มี Project ที่ตรงกับ BU ที่เลือก");
                    }
                },
                error: function (xhr, status, error) {
                    console.error("❌ โหลด Project ไม่สำเร็จ:", error);
                },
                complete: function () {
                    console.log("✅ โหลด Project เสร็จสมบูรณ์");
                }
            });
        }



        $(document).ready(function () {
            loadBUOptions(function () {
                console.log("โหลด BU สำเร็จแล้ว พร้อมใช้งาน ✅");
            });
        });
    </script>
} *@
@section Scripts {
    <script>
        let projectTagify = null; // 🧠 ตัวแปรกลางไว้เช็ค & ทำลาย
        let buTagify = null;

        function loadBUOptions(callback) {
            $('.loader-wrapper').show();

            $.ajax({
                url: baseUrl + 'OtherSettings/Page_Load',
                type: 'POST',
                dataType: 'json',
                success: function (res) {
                    if (res.success && res.buList?.length) {
                        const buInput = document.querySelector('#ddl-bu-shop-event');

                        if (buTagify) {
                            buTagify.removeAllListeners();
                            buTagify.destroy();
                            buTagify = null;
                        }

                        buTagify = new Tagify(buInput, {
                            tagTextProp: "label", // ✅ จุดที่ทำให้แสดงชื่อ (label) แทนค่า (value)
                            whitelist: res.buList.map(x => ({
                                value: x.ID.toString(),
                                label: x.Name
                            })),
                            dropdown: {
                                enabled: 0,
                                maxItems: 20,
                                closeOnSelect: false,
                                classname: "tagify-dropdown"
                            }
                        });

                        buInput.addEventListener('focus', () => buTagify.dropdown.show.call(buTagify));

                        buTagify.on('change', function () {
                            const selectedBU = buTagify.value.map(x => x.value).join(',');
                            loadProjectOptions(selectedBU);
                        });

                        if (typeof callback === 'function') callback();
                    }
                },
                error: function () {
                    console.error("โหลด BU ไม่สำเร็จ");
                },
                complete: function () {
                    $('.loader-wrapper').fadeOut();
                }
            });
        }

        function loadProjectOptions(buIds) {
            console.log("🔍 BU ที่เลือก:", buIds);

            const container = document.querySelector('#project-dropdown-container');
            const inputId = 'ddl-project-shop-event';

            // 🔄 ล้างตัวเก่าแบบเด็ดขาด
            const oldInput = document.getElementById(inputId);
            if (oldInput) {
                if (oldInput._tagify) {
                    oldInput._tagify.destroy();
                }
                oldInput.remove(); // ลบ input ออกเลย
            }

            // 🟡 Show mini loader
            const loaderHTML = `
                <div id="project-loading" class="d-flex align-items-center gap-2">
                    <div class="spinner-border text-primary spinner-border-sm" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <span>กำลังโหลดโครงการ...</span>
                </div>`;
            container.querySelector('form').innerHTML = loaderHTML;

            // 📡 เรียก AJAX
            $.ajax({
                url: baseUrl + 'OtherSettings/GetProjectListByBU',
                type: 'POST',
                dataType: 'json',
                data: { L_BUID: buIds },
                success: function (res) {
                    console.log("✅ Project Response:", res);

                    // ✅ สร้าง input ใหม่
                    const newInput = document.createElement('input');
                    newInput.setAttribute('id', inputId);
                    newInput.setAttribute('name', 'tags');
                    newInput.setAttribute('class', 'form-control');
                    newInput.setAttribute('placeholder', 'Type to search...');

                    const form = container.querySelector('form');
                    form.innerHTML = ''; // เคลียร์ loader
                    form.appendChild(newInput);

                    // ✅ Apply Tagify ใหม่
                    const tagify = new Tagify(newInput, {
                        tagTextProp: "label", // ✅ จุดที่ทำให้แสดงชื่อโครงการ
                        whitelist: res.data.map(x => ({
                            value: x.ProjectID,
                            label: x.ProjectNameTH
                        })),
                        dropdown: {
                            enabled: 0,
                            maxItems: 20,
                            closeOnSelect: true,
                            classname: "tagify-dropdown"
                        }
                    });


                    newInput.addEventListener('focus', () => tagify.dropdown.show.call(tagify));
                },
                error: function (xhr, status, error) {
                    console.error("❌ โหลด Project ไม่สำเร็จ:", error);
                },
                complete: function () {
                    console.log("✅ โหลด Project เสร็จสมบูรณ์");
                }
            });
        }




        $(document).ready(function () {
            loadBUOptions(() => {
                console.log("✅ โหลด BU แล้ว พร้อมใช้");
            });
        });
    </script>
}



