@{
    ViewData["Title"] = "Index";
    Layout = "~/Views/Shared/_LayoutSite.cshtml";
    @model List<Project.CSS.Revise.Web.Models.Pages.CSResponse.GetlistCountByCS>
}
<style>
    .no-select {
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
    }

</style>
<div class="container-fluid">
    <div class="page-title">
        <div class="row">
            <div class="col-6">
                <h4>CS Response</h4>
            </div>
            <div class="col-6">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item">
                        <a href="index.html">
                            <svg class="stroke-icon">
                                <use xlink:href="@Url.Content("~/assets/svg/icon-sprite.svg#stroke-home")"></use>
                            </svg>
                        </a>
                    </li>
                    <li class="breadcrumb-item">Setting</li>
                    <li class="breadcrumb-item active">CS Response</li>
                </ol>
            </div>
        </div>
    </div>
</div>
<div id="secure-area" oncontextmenu="return false;" class="no-select">
<!-- Container-fluid starts-->
<div class="container-fluid">
        <div class="box-col-12">
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <ul class="simple-wrapper nav nav-tabs" id="Other-Settings-Tab-filter" role="tablist">
                            <li class="nav-item"><a class="nav-link active txt-primary" id="counter-tab" data-bs-toggle="tab" href="#counter-filter" role="tab" aria-controls="counter-tab" aria-selected="true"><i class="icofont icofont-building"></i>Unit</a></li>
                            <li class="nav-item"><a class="nav-link txt-primary" id="shop-event-tab" data-bs-toggle="tab" href="#shop-event-filter" role="tab" aria-controls="shop-event-tab" aria-selected="false"><i class="icofont icofont-man-in-glasses"></i>CS</a></li>
                        </ul>
                        <div class="tab-content" id="Other-Settings-Tab-filter-Content">
                            <div class="tab-pane fade show active" id="counter-filter" role="tabpanel" aria-labelledby="counter-tab">
                                <div class="p-3">
                                    <div class="row mb-3">
                                    <div class="col-xl-3 xl-30 box-col-12"> @* card 1 *@
                                        <div class="md-sidebar">
                                            <a class="btn btn-primary email-aside-toggle md-sidebar-toggle">Job filter</a>
                                            <div class="md-sidebar-aside job-sidebar">
                                                <div class="default-according style-1 faq-accordion job-accordion">
                                                    <div class="accordion" id="accordionExample">
                                                        <div class="card">
                                                            <div class="card-header" id="headingOne">
                                                                <h2 class="mb-0">
                                                                    <button class="btn btn-link btn-block text-start" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">Filter</button>
                                                                </h2>
                                                            </div>
                                                            <div class="collapse show" id="collapseOne" aria-labelledby="headingOne" data-bs-parent="#accordionExample">
                                                                <div class="card-body filter-cards-view animate-chk">
                                                                    <!-- 🔍 พนักงาน -->
                                                                    <div class="job-filter mb-3">
                                                                        <label for="csUserSelect" class="form-label fw-bold">ชื่อพนักงาน</label>
                                                                                @{
                                                                                    var csUsers = ViewBag.listAllCSUser as IEnumerable<dynamic> ?? Enumerable.Empty<dynamic>();
                                                                                }
                                                                                <select id="csUserSelect" class="form-control searchable-select">
                                                                                    @foreach (var u in csUsers)
                                                                                    {
                                                                                        var val = (u.ValueString ?? u.ValueInt ?? u.Value ?? u.ID ?? "").ToString();
                                                                                        var text = (u.Text ?? u.FullName ?? u.Name ?? "").ToString();
                                                                                        <option value="@val">@text</option>
                                                                                    }
                                                                                </select>
                                                                    </div>
                                                                    <div class="job-filter mb-3">
                                                                        <label for="csUserSelectview" class="form-label fw-bold">ประเภทการแสดง</label>
                                                                            <select id="csUserSelectview" class="form-control searchable-select">
                                                                                <option value="">ทั้งหมด</option>
                                                                                <option value="1">CS</option>
                                                                                <option value="2">Other</option>
                                                                            </select>
                                                                    </div>

                                                                    <!-- 🏢 โครงการ -->
                                                                    <div class="job-filter mb-3">
                                                                        <label for="projectSelect" class="form-label fw-bold">โครงการ</label>
                                                                            @{
                                                                                var _projects = ViewBag.listDDlAllProject as IEnumerable<dynamic> ?? Enumerable.Empty<dynamic>();
                                                                            }
                                                                            <select id="projectSelect" class="form-control searchable-select">
                                                                                    @foreach (var p in _projects)
                                                                                {
                                                                                    var val = (p.ValueString ?? p.ValueInt ?? p.Value ?? p.ID ?? "").ToString();
                                                                                    var text = (p.Text ?? p.ProjectName ?? p.Name ?? "").ToString();
                                                                                    <option value="@val">@text</option>
                                                                                }
                                                                            </select>
                                                                    </div>

                                                                    <!-- 🏢 อาคาร -->
                                                                    <div class="job-filter mb-3">
                                                                                <label for="buildingMultiSelect" class="form-label fw-bold">อาคาร/โซน</label>
                                                                        <select id="buildingMultiSelect" class="form-control multi-select" multiple>
      
                                                                        </select>
                                                                    </div>

                                                                    <!-- 🧱 ชั้น -->
                                                                    <div class="job-filter mb-3">
                                                                        <label for="floorMultiSelect" class="form-label fw-bold">ชั้น</label>
                                                                        <select id="floorMultiSelect" class="form-control multi-select" multiple>

                                                                        </select>
                                                                    </div>

                                                                    <!-- 🚪 ห้อง -->
                                                                    <div class="job-filter mb-3">
                                                                        <label for="roomMultiSelect" class="form-label fw-bold">Unit</label>
                                                                        <select id="roomMultiSelect" class="form-control multi-select" multiple>

                                                                        </select>
                                                                    </div>

                                                                    <!-- 🔎 ปุ่มค้นหา -->
                                                                    <button id="btnSearch" class="btn btn-primary text-center" type="button">Search 🔍</button>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-xl-9 xl-70 box-col-12"> 
                                        <div class="card">
                                            <div class="card-header d-flex justify-content-between align-items-center">
                                                <div>
                                                    <h4 id="name_project_selected"></h4>
                                                    <small id="row_count" class="text-muted"></small>
                                                </div>
                                                <div>
                                                    <button type="button" class="btn btn-primary btn-sm" id="save_change_cs_responsive">
                                                        💾 Save
                                                    </button>
                                                </div>
                                            </div>
                                            <div class="card-body">
                                                        <div class="table-responsive" id="div_Tb_CS_Response" style="display:block; max-height:550px; overflow-y:auto;">
                                                    <table class="table table-bordered table-striped align-middle text-center" id="Tb_CS_Response">
                                                        <thead class="table-light">
                                                            <tr>
                                                                <th scope="col" class="text-center">
                                                                    <input class="form-check-input" type="checkbox" id="checkAll">
                                                                </th>
                                                                <th scope="col">Unit</th>
                                                                <th scope="col">CS Name</th>
                                                                <th scope="col">Update</th>
                                                            </tr>
                                                        </thead>
                                                         <tbody id="Tb_CS_Response_body">

                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    </div>
                                </div>
                            </div>
                            <div class="tab-pane fade" id="shop-event-filter" role="tabpanel" aria-labelledby="shop-event-tab">
                                    <div class="p-3">
                                    <div class="table-responsive">
                                        <table class="table table-sm align-middle">
                                            <thead class="table-light">
                                                <tr>
                                                    <th style="width:36px;"></th>
                                                    <th>User (TH / EN)</th>
                                                    <th>Email</th>
                                                    <th>Mobile</th>
                                                    <th class="text-end">Projects</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                @foreach (var user in Model)
                                                {
                                                    // dedupe projects (in case of duplicates)
                                                    var projects = user.Project
                                                    .GroupBy(p => p.ProjectID)
                                                    .Select(g => g.First())
                                                    .OrderBy(p => p.ProjectName)
                                                    .ToList();

                                                    var userRowId = $"u_{user.ID}";
                                                    var totalUnits = projects.Sum(p => p.CountUnit);

                                                    <tr>
                                                        <td>
                                                            <button class="btn btn-outline-primary btn-sm"
                                                                    type="button"
                                                                    data-bs-toggle="collapse"
                                                                    data-bs-target="#@userRowId"
                                                                    aria-expanded="false"
                                                                    aria-controls="@userRowId">
                                                                <i class="bi bi-caret-down-square"></i>
                                                            </button>
                                                        </td>
                                                        <td>
                                                            <div class="fw-semibold">@user.FullnameTH</div>
                                                            <div class="text-muted small">@user.FullnameEN</div>
                                                        </td>
                                                        <td>@user.Email</td>
                                                        <td>@user.Mobile</td>
                                                        <td class="text-end">
                                                            <span class="badge bg-secondary">@projects.Count() projects</span>
                                                            <span class="badge bg-dark-subtle text-dark">@totalUnits units</span>
                                                        </td>
                                                    </tr>

                                                    <!-- child: projects table -->
                                                    <tr class="collapse" id="@userRowId">
                                                        <td></td>
                                                        <td colspan="4">
                                                            <div class="card border-0">
                                                                <div class="card-body p-2">
                                                                    <div class="table-responsive">
                                                                        <table class="table table-sm mb-0">
                                                                            <thead>
                                                                                <tr class="table-secondary">
                                                                                    <th style="width:36px;"></th>
                                                                                    <th>Project</th>
                                                                                    <th class="text-end">Units</th>
                                                                                    <th>Status</th>
                                                                                </tr>
                                                                            </thead>
                                                                            <tbody>
                                                                                @foreach (var proj in projects)
                                                                                {
                                                                                    var projRowId = $"p_{user.ID}_{proj.ProjectID}";
                                                                                    <tr>
                                                                                        <td>
                                                                                            <button class="btn btn-outline-secondary btn-sm"
                                                                                                    type="button"
                                                                                                    data-bs-toggle="collapse"
                                                                                                    data-bs-target="#@projRowId"
                                                                                                    aria-expanded="false"
                                                                                                    aria-controls="@projRowId">
                                                                                                <i class="bi bi-caret-right-square"></i>
                                                                                            </button>
                                                                                        </td>
                                                                                        <td class="fw-semibold">@proj.ProjectName</td>
                                                                                        <td class="text-end">
                                                                                            <span class="badge bg-dark-subtle text-dark">@proj.CountUnit</span>
                                                                                        </td>
                                                                                        <td>
                                                                                            <!-- quick inline summary badges (collapsed detail below) -->
                                                                                            @foreach (var uni in proj.Unit)
                                                                                            {
                                                                                                string summaryBadge = uni.UnitStatus switch
                                                                                                {
                                                                                                    1 => "badge bg-light text-dark", // ว่าง
                                                                                                    2 => "badge bg-danger",          // จอง
                                                                                                    3 => "badge bg-primary",         // สัญญา
                                                                                                    4 => "badge bg-success",         // โอน
                                                                                                    _ => "badge bg-secondary"
                                                                                                };
                                                                                                <span class="@summaryBadge me-1 mb-1">@uni.UnitStatusName @uni.TotalUnit</span>
                                                                                            }
                                                                                        </td>
                                                                                    </tr>

                                                                                    <!-- grandchild: per-project unit-status breakdown -->
                                                                                    <tr class="collapse" id="@projRowId" data-bs-parent="#@userRowId">
                                                                                        <td></td>
                                                                                        <td colspan="3">
                                                                                            <div class="card border-0">
                                                                                                <div class="card-body py-2">
                                                                                                    <div class="table-responsive">
                                                                                                        <table class="table table-sm table-borderless mb-0">
                                                                                                            <thead>
                                                                                                                <tr class="text-muted">
                                                                                                                    <th style="width:30%;">Unit Status</th>
                                                                                                                    <th style="width:70%;">Count</th>
                                                                                                                </tr>
                                                                                                            </thead>
                                                                                                            <tbody>
                                                                                                                @foreach (var uni in proj.Unit)
                                                                                                                {
                                                                                                                    string badgeClass = uni.UnitStatus switch
                                                                                                                    {
                                                                                                                        1 => "badge bg-light text-dark", // ว่าง
                                                                                                                        2 => "badge bg-danger",          // จอง
                                                                                                                        3 => "badge bg-primary",         // สัญญา
                                                                                                                        4 => "badge bg-success",         // โอน
                                                                                                                        _ => "badge bg-secondary"
                                                                                                                    };
                                                                                                                    <tr>
                                                                                                                        <td>
                                                                                                                            <span class="@badgeClass">@uni.UnitStatusName</span>
                                                                                                                        </td>
                                                                                                                        <td>
                                                                                                                            <div class="d-flex justify-content-between">
                                                                                                                                <div class="fw-semibold">@uni.TotalUnit</div>
                                                                                                                            </div>
                                                                                                                        </td>
                                                                                                                    </tr>
                                                                                                                }
                                                                                                            </tbody>
                                                                                                        </table>
                                                                                                    </div>
                                                                                                </div>
                                                                                            </div>
                                                                                        </td>
                                                                                    </tr>
                                                                                }
                                                                            </tbody>
                                                                        </table>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                }
                                            </tbody>
                                        </table>
                                    </div>
                                    </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Container-fluid Ends-->
</div>

@section Scripts {
    <script src="~/js/Pages/CSResponse/index.js?ver=@DateTime.Now.Ticks.ToString()"></script>
}